<!DOCTYPE html>
<!--
  Finance Module Mini App
  -----------------------

  This Mini App extends the simple expense tracker to include a
  navigational menu and a finance module that displays the total
  balance in USD with conversions to RUB and UAH (–≥—Ä–Ω), along with
  the ability to record incomes and expenses.  Data is stored in
  localStorage so that it persists across sessions.  Exchange rates
  are hard-coded for demonstration purposes; adjust them to your
  requirements.

  To launch this Mini App, host it on a secure domain and use a
  web_app button from your bot.  Remember to add the domain via
  @BotFather as described in the documentation„Äê780425990359058‚Ä†L296-L321„Äë.
-->
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–æ–¥—É–ª–∏</title>
  <style>
    :root {
      --bg-color: var(--tg-theme-bg-color, #f7f9fc);
      --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
      --text-color: var(--tg-theme-text-color, #1f2937);
      --subtext-color: var(--tg-theme-hint-color, #6b7280);
      --accent-color: var(--tg-theme-button-color, #3b82f6);
      --accent-text-color: var(--tg-theme-button-text-color, #ffffff);
      --radius: 10px;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background-color: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 16px;
      margin-bottom: 16px;
    }
    h1, h2 {
      margin: 0 0 16px;
    }
    .module-button {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background-color: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      cursor: pointer;
      margin-bottom: 12px;
    }
    .module-button:hover {
      background-color: rgba(0,0,0,0.03);
    }
    .module-title {
      font-size: 1.1rem;
    }
    .balance-display {
      text-align: center;
      margin-bottom: 16px;
    }
    .balance-display .usd {
      font-size: 2.2rem;
      font-weight: bold;
    }
    .balance-display .other {
      font-size: 0.9rem;
      color: var(--subtext-color);
    }
    form {
      margin-top: 16px;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--subtext-color);
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #d1d5db;
      border-radius: var(--radius);
      background-color: var(--bg-color);
      color: var(--text-color);
      box-sizing: border-box;
    }
    button {
      display: inline-block;
      background-color: var(--accent-color);
      color: var(--accent-text-color);
      border: none;
      border-radius: var(--radius);
      padding: 10px 16px;
      margin-top: 12px;
      width: 100%;
      font-size: 1rem;
      cursor: pointer;
    }
    button:active {
      filter: brightness(0.9);
    }
    .transactions {
      margin-top: 16px;
    }
    .transaction-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .transaction-item:last-child {
      border-bottom: none;
    }
    .transaction-left {
      flex: 1;
    }
    .transaction-amount {
      white-space: nowrap;
      font-weight: bold;
    }
    .back-button {
      display: inline-block;
      margin-bottom: 16px;
      color: var(--accent-color);
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- Content will be injected by JavaScript -->
  </div>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    Telegram.WebApp.ready();
    // Exchange rates (1 USD = x currency)
    const EXCHANGE_RATES = {
      RUB: 90,
      UAH: 37
    };
    // Transactions array; will be loaded from localStorage
    let transactions = [];
    // App container
    const app = document.getElementById('app');

    // Utility functions to load/save transactions
    function loadTransactions() {
      const data = localStorage.getItem('finance_transactions');
      if (data) {
        try {
          transactions = JSON.parse(data);
        } catch (e) {
          console.error('Invalid transaction data', e);
          transactions = [];
        }
      }
    }
    function saveTransactions() {
      localStorage.setItem('finance_transactions', JSON.stringify(transactions));
    }
    // Categories list (derived from transactions)
    let categories = [];

    // Compute total in USD based on type
    function computeTotals() {
      let usdTotal = 0;
      transactions.forEach(tx => {
        let usdVal;
        if (tx.currency === 'USD') usdVal = tx.amount;
        else if (tx.currency === 'RUB') usdVal = tx.amount / EXCHANGE_RATES.RUB;
        else if (tx.currency === 'UAH') usdVal = tx.amount / EXCHANGE_RATES.UAH;
        else usdVal = 0;
        usdTotal += tx.type === 'income' ? usdVal : -usdVal;
      });
      const rubTotal = usdTotal * EXCHANGE_RATES.RUB;
      const uahTotal = usdTotal * EXCHANGE_RATES.UAH;
      return { usdTotal, rubTotal, uahTotal };
    }
    // Render menu page
    function showMenu() {
      document.title = '–ú–æ–¥—É–ª–∏';
      app.innerHTML = '';
      const title = document.createElement('h1');
      title.textContent = '–ú–æ–¥—É–ª–∏';
      app.appendChild(title);
      const financeBtn = document.createElement('div');
      financeBtn.className = 'module-button';
      financeBtn.innerHTML = `<span class="module-title">–§–∏–Ω–∞–Ω—Å—ã</span><span>üíµ</span>`;
      financeBtn.onclick = showFinance;
      app.appendChild(financeBtn);
    }
    // Render finance module
    function showFinance() {
      document.title = '–§–∏–Ω–∞–Ω—Å—ã';
      app.innerHTML = '';
      // Back button
      const backBtn = document.createElement('div');
      backBtn.className = 'back-button';
      backBtn.textContent = '‚Üê –ú–µ–Ω—é';
      backBtn.onclick = showMenu;
      app.appendChild(backBtn);
      // Card for balance
      const balanceCard = document.createElement('div');
      balanceCard.className = 'card';
      const { usdTotal, rubTotal, uahTotal } = computeTotals();
      balanceCard.innerHTML = `
        <div class="balance-display">
          <div class="usd">$${usdTotal.toFixed(2)}</div>
          <div class="other">${rubTotal.toFixed(0)} ‚ÇΩ</div>
          <div class="other">${uahTotal.toFixed(0)} –≥—Ä–Ω</div>
        </div>
      `;
      app.appendChild(balanceCard);
      // Card for transaction form
      const formCard = document.createElement('div');
      formCard.className = 'card';
      formCard.innerHTML = `
        <h2>–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</h2>
        <form id="transaction-form">
          <label>–°—É–º–º–∞
            <input type="number" id="tx-amount" step="0.01" min="0" required />
          </label>
          <label>–í–∞–ª—é—Ç–∞
            <select id="tx-currency">
              <option value="USD">USD</option>
              <option value="RUB">RUB</option>
              <option value="UAH">UAH</option>
            </select>
          </label>
          <label>–¢–∏–ø
            <select id="tx-type">
              <option value="income">–î–æ—Ö–æ–¥</option>
              <option value="expense">–†–∞—Å—Ö–æ–¥</option>
            </select>
          </label>
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è
            <input type="text" id="tx-category" list="category-list" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ï–¥–∞" />
            <datalist id="category-list"></datalist>
          </label>
          <label>–û–ø–∏—Å–∞–Ω–∏–µ
            <input type="text" id="tx-desc" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" />
          </label>
          <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
      `;
      app.appendChild(formCard);
      // Card for categories overview
      const categoriesCard = document.createElement('div');
      categoriesCard.className = 'card';
      categoriesCard.innerHTML = `<h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2><div id="category-list-view" class="transactions"></div>`;
      app.appendChild(categoriesCard);
      // Card for transactions list
      const listCard = document.createElement('div');
      listCard.className = 'card';
      listCard.innerHTML = `<h2>–û–ø–µ—Ä–∞—Ü–∏–∏</h2><div id="tx-list" class="transactions"></div>`;
      app.appendChild(listCard);
      // Render existing data
      renderCategories();
      renderTransactions();
      // Bind form submit
      document.getElementById('transaction-form').onsubmit = addTransaction;
    }
    // Render transaction list
    function renderTransactions() {
      const list = document.getElementById('tx-list');
      if (!list) return;
      list.innerHTML = '';
      if (transactions.length === 0) {
        list.innerHTML = `<p style="color: var(--subtext-color);">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π.</p>`;
        return;
      }
      transactions.forEach(tx => {
        const div = document.createElement('div');
        div.className = 'transaction-item';
        const left = document.createElement('div');
        left.className = 'transaction-left';
        left.innerHTML = `<div>${tx.timestamp}</div><div>${tx.type === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'} ‚Äî ${tx.desc || ''}</div>`;
        const amount = document.createElement('div');
        amount.className = 'transaction-amount';
        const sign = tx.type === 'income' ? '+' : '-';
        amount.textContent = `${sign}${tx.amount.toFixed(2)} ${tx.currency}`;
        div.appendChild(left);
        div.appendChild(amount);
        list.appendChild(div);
      });
      // Update balance display
      const { usdTotal, rubTotal, uahTotal } = computeTotals();
      const balanceDisplay = document.querySelector('.balance-display');
      if (balanceDisplay) {
        balanceDisplay.innerHTML = `
          <div class="usd">$${usdTotal.toFixed(2)}</div>
          <div class="other">${rubTotal.toFixed(0)} ‚ÇΩ</div>
          <div class="other">${uahTotal.toFixed(0)} –≥—Ä–Ω</div>
        `;
      }
      // Update categories overview
      renderCategories();
    }
    // Add new transaction
    function addTransaction(evt) {
      evt.preventDefault();
      const amount = parseFloat(document.getElementById('tx-amount').value);
      const currency = document.getElementById('tx-currency').value;
      const type = document.getElementById('tx-type').value;
      const desc = document.getElementById('tx-desc').value.trim();
      const category = document.getElementById('tx-category').value.trim() || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
      if (!amount || amount <= 0) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
        return;
      }
      const tx = {
        amount,
        currency,
        type,
        category,
        desc,
        timestamp: new Date().toLocaleString(),
      };
      transactions.push(tx);
      saveTransactions();
      renderTransactions();
      // Optionally send data back to bot
      // Telegram.WebApp.sendData(JSON.stringify(tx));
      // Reset form
      document.getElementById('transaction-form').reset();
    }

    // Render categories overview
    function renderCategories() {
      // Derive categories and their totals
      const catTotals = {};
      categories = [];
      transactions.forEach(tx => {
        const cat = tx.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
        categories.push(cat);
        let usdVal;
        if (tx.currency === 'USD') usdVal = tx.amount;
        else if (tx.currency === 'RUB') usdVal = tx.amount / EXCHANGE_RATES.RUB;
        else if (tx.currency === 'UAH') usdVal = tx.amount / EXCHANGE_RATES.UAH;
        else usdVal = 0;
        if (!catTotals[cat]) catTotals[cat] = 0;
        catTotals[cat] += tx.type === 'income' ? usdVal : -usdVal;
      });
      // Unique categories
      categories = [...new Set(categories)];
      // Update datalist options
      const dl = document.getElementById('category-list');
      if (dl) {
        dl.innerHTML = '';
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          dl.appendChild(opt);
        });
      }
      // Render category list view
      const view = document.getElementById('category-list-view');
      if (!view) return;
      view.innerHTML = '';
      if (categories.length === 0) {
        view.innerHTML = `<p style="color: var(--subtext-color);">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.</p>`;
        return;
      }
      categories.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'transaction-item';
        const left = document.createElement('div');
        left.className = 'transaction-left';
        left.innerHTML = `<div>${cat}</div>`;
        const amount = document.createElement('div');
        amount.className = 'transaction-amount';
        const totalUsd = catTotals[cat] || 0;
        const sign = totalUsd >= 0 ? '' : '-';
        amount.textContent = `${sign}$${Math.abs(totalUsd).toFixed(2)}`;
        div.appendChild(left);
        div.appendChild(amount);
        // On click filter by category
        div.style.cursor = 'pointer';
        div.onclick = () => showCategory(cat);
        view.appendChild(div);
      });
    }

    // Show transactions filtered by a single category
    function showCategory(cat) {
      document.title = `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${cat}`;
      app.innerHTML = '';
      const backBtn = document.createElement('div');
      backBtn.className = 'back-button';
      backBtn.textContent = '‚Üê –§–∏–Ω–∞–Ω—Å—ã';
      backBtn.onclick = showFinance;
      app.appendChild(backBtn);
      // Header with category and totals
      const headerCard = document.createElement('div');
      headerCard.className = 'card';
      // Compute category total in different currencies
      let usdTotal = 0;
      transactions.forEach(tx => {
        if (tx.category !== cat) return;
        let usd;
        if (tx.currency === 'USD') usd = tx.amount;
        else if (tx.currency === 'RUB') usd = tx.amount / EXCHANGE_RATES.RUB;
        else if (tx.currency === 'UAH') usd = tx.amount / EXCHANGE_RATES.UAH;
        else usd = 0;
        usdTotal += tx.type === 'income' ? usd : -usd;
      });
      const rubTotal = usdTotal * EXCHANGE_RATES.RUB;
      const uahTotal = usdTotal * EXCHANGE_RATES.UAH;
      headerCard.innerHTML = `
        <div class="balance-display">
          <div class="usd">$${usdTotal.toFixed(2)}</div>
          <div class="other">${rubTotal.toFixed(0)} ‚ÇΩ</div>
          <div class="other">${uahTotal.toFixed(0)} –≥—Ä–Ω</div>
        </div>
      `;
      app.appendChild(headerCard);
      // List of transactions for category
      const listCard = document.createElement('div');
      listCard.className = 'card';
      listCard.innerHTML = `<h2>–û–ø–µ—Ä–∞—Ü–∏–∏: ${cat}</h2><div id="cat-tx-list" class="transactions"></div>`;
      app.appendChild(listCard);
      const list = document.getElementById('cat-tx-list');
      const filtered = transactions.filter(tx => tx.category === cat);
      if (filtered.length === 0) {
        list.innerHTML = `<p style="color: var(--subtext-color);">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</p>`;
      } else {
        filtered.forEach(tx => {
          const div = document.createElement('div');
          div.className = 'transaction-item';
          const left = document.createElement('div');
          left.className = 'transaction-left';
          left.innerHTML = `<div>${tx.timestamp}</div><div>${tx.type === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'} ‚Äî ${tx.desc || ''}</div>`;
          const amount = document.createElement('div');
          amount.className = 'transaction-amount';
          const sign = tx.type === 'income' ? '+' : '-';
          amount.textContent = `${sign}${tx.amount.toFixed(2)} ${tx.currency}`;
          div.appendChild(left);
          div.appendChild(amount);
          list.appendChild(div);
        });
      }
    }
    // Initial load
    loadTransactions();
    showMenu();
  </script>
</body>
</html>